# Introduction
The simulation of node reliability

本文涉及的代码的编码为GBK编码，如果遇到中文注释乱码的问题，请更改编码方式为GBK。

## ori_mttdlsim_3fuben.c
这个是原有的版本，内部实现了潜在扇区错误，硬盘定期刷新的事件驱动能力。

此外磁盘预测预警早已经加入到这个版本中。

## mttdlsim_3fuben.cpp
这个是当前跟进的版本，目前主要是加入node failure等相关事件，考虑多种冗余机制（副本和纠删码），以块的粒度来分析分布式系统的可靠性。

整体代码基于Event-driven的事件驱动模型，对于节点故障引起的块data loss这一部分使用概率模型来求解。

### 第一版进度
对旧代码进行整合，核对了逻辑，以期望形成一个更易维护的代码。

1. 关于堆的函数汇总到一起
2. 关于event创建，插入堆等相关函数的包装
3. 关于event记录到event数组的插入和删除函数的封装
4. 关于windows下visual studio运行调试的支持
5. 关于Makefile的release和debug的包装
6. 关于全局变量以及log TRACE的统一整理

**还缺少的内容**
1. 多种编码方案的支持
2. 判断当前的故障是否存在数据丢失风险的故障集合
3. 给定故障组合类型，拿到发生数据丢失的概率

对于1，打算增加rs1,rs2参数。
对于2和3，还需要进一步细化，主要是需要将确定好数据的散布方式，以及有数据丢失风险的故障集合类型。

### 第二版进度
1. 添加了几种RS coding类型，即RShorizontal和RSvertical，水平和垂直两种
2. 在判断是否引起数据丢失的逻辑上，要做很多的工作。现在的策略是从故障磁盘中选择x个（使用组合算法），从故障节点中选择m-x个，然后将这m个故障传入到func_probability中，交给它来计算当前组合是否会引起数据丢失
3. 在func_probability中，需要执行以下步骤：
    1. 跳过不包含本次故障的disk或者node
    2. 判断当前的故障是否跨越足够多的机架（可能引起数据丢失）
    3. 根据故障情形，计算故障丢失概率
    4. 根据概率判断是否发生数据丢失
4. 对于步骤3，需要能够根据不同的coding方案执行不同的操作，但是基本的逻辑都是一定的，传入故障的diskarray，nodearray，以及编码方案，判断是否引起数据丢失。